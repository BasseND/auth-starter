FROM node:20-alpine

WORKDIR /app

# Install build dependencies for native modules and SSL libraries for Prisma
RUN apk add --no-cache python3 make g++ openssl-dev openssl libssl3 libcrypto3 libc6-compat

# Copy package files
COPY package*.json ./

# Install dependencies
RUN npm install

# Copy source code (excluding node_modules)
COPY . .

# Remove any existing node_modules and reinstall to ensure native modules are built for container architecture
RUN rm -rf node_modules && npm install

# Clear Prisma cache and generate client with correct binary target
RUN rm -rf node_modules/.prisma node_modules/@prisma/client/.prisma
RUN npx prisma generate

# Expose port 3000
EXPOSE 3000

# Create startup script
RUN echo '#!/bin/sh' > /app/start.sh && \
    echo 'echo "Waiting for database..."' >> /app/start.sh && \
    echo 'sleep 5' >> /app/start.sh && \
    echo 'echo "Running Prisma migrations..."' >> /app/start.sh && \
    echo 'npx prisma migrate deploy' >> /app/start.sh && \
    echo 'echo "Starting application..."' >> /app/start.sh && \
    echo 'npm run start:dev' >> /app/start.sh && \
    chmod +x /app/start.sh

# Start with migration and then development server
CMD ["/app/start.sh"]